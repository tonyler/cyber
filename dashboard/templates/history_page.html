{% extends 'base.html' %}

{% block title %}History - Cybernetics{% endblock %}

{% block content %}
<div class="container">
    {% set page_title = page_title or 'ACTIVITY HISTORY' %}
    {% if platform and platform|lower != 'all' %}
        {% set page_title = platform|upper ~ ' ACTIVITY' %}
    {% endif %}
    <h1>[ {{ page_title }} ]</h1>

    <div class="panel">
        <form method="get" action="{{ form_action or url_for('history_page') }}" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <label>MONTH:</label>
            <input type="month" name="month" value="{{ month }}">

            <label>PLATFORM:</label>
            <select name="platform">
                <option value="all" {% if platform == 'All' %}selected{% endif %}>ALL</option>
                <option value="x" {% if platform == 'X' %}selected{% endif %}>X</option>
                <option value="reddit" {% if platform == 'Reddit' %}selected{% endif %}>REDDIT</option>
            </select>

            <button type="submit">FILTER</button>
        </form>
    </div>

    {% if activities %}
    <div class="panel">
        <h2>{{ activities|length }} ACTIVITIES - {{ platform|upper }}</h2>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>TIME</th>
                        <th>USER</th>
                        <th>PLATFORM</th>
                        <th>TYPE</th>
                        <th>LINK</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in activities %}
                    <tr>
                        <td>{{ activity.date }}</td>
                        <td>{{ activity.time }}</td>
                        <td>{{ activity.discord_user }}</td>
                        <td>
                            {% if activity.platform == 'x' %}
                            X
                            {% else %}
                            REDDIT
                            {% endif %}
                        </td>
                        <td>{{ activity.activity_type or 'N/A' }}</td>
                        <td>
                            {% if activity.activity_url %}
                            <a href="{{ activity.activity_url }}" target="_blank" rel="noopener noreferrer">VIEW â†’</a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="panel text-center">
        <h3>NO ACTIVITIES FOUND</h3>
        <p class="text-muted mt-2">{{ month }} - {{ platform|upper }}</p>
        <p class="text-muted">TRY SELECTING A DIFFERENT MONTH OR PLATFORM</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form when inputs change
document.addEventListener('DOMContentLoaded', function() {
    const monthInput = document.querySelector('input[name="month"]');
    const platformSelect = document.querySelector('select[name="platform"]');

    if (monthInput) {
        monthInput.addEventListener('change', function() {
            this.form.submit();
        });
    }

    if (platformSelect) {
        platformSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
});
</script>
{% endblock %}
